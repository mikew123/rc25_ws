amcl:
  ros__parameters:
    robot_model_type: "nav2_amcl::OmniMotionModel"
    tf_broadcast: False #true
    scan_topic: "" #scan
    set_initial_pose: True # required for nav2 to start 
    initial_pose: {x: 0.0, y: 0.0, z: 0.0, yaw: 0.0} # updated when nav button pressed

bt_navigator:
  ros__parameters:
    global_frame: map
    robot_base_frame: base_footprint
    odom_topic: /wheel_odom
    bt_loop_duration: 10
    default_server_timeout: 50 #20
    wait_for_service_timeout: 1000
    action_server_result_timeout: 60.0 #900.0
    navigators: ["navigate_to_pose", "navigate_through_poses"]
    navigate_to_pose:
      plugin: "nav2_bt_navigator::NavigateToPoseNavigator"
    navigate_through_poses:
      plugin: "nav2_bt_navigator::NavigateThroughPosesNavigator"
    error_code_names:
      - compute_path_error_code
      - follow_path_error_code

controller_server:
  ros__parameters:
    controller_frequency: 10.0 #20.0 
    costmap_update_timeout: 0.30
    min_x_velocity_threshold: 0.001
    min_y_velocity_threshold: 0.001
    min_theta_velocity_threshold: 0.001
    failure_tolerance: 0.3
    progress_checker_plugins: ["progress_checker"]
    goal_checker_plugins: ["goal_checker"]
    controller_plugins: ["FollowPath"]
    use_realtime_priority: false
    publish_zero_velocity: true
    
    progress_checker:
      plugin: "nav2_controller::SimpleProgressChecker"
      required_movement_radius: 1.5 #1.0
      movement_time_allowance: 20.0 #10.0
      
    goal_checker:
      stateful: True
      plugin: "nav2_controller::SimpleGoalChecker"
      xy_goal_tolerance: 1.5 #1.0 #0.25
      yaw_goal_tolerance: 3.0 #3.14 #0.25
      
    FollowPath:
      plugin: "nav2_mppi_controller::MPPIController"
      time_steps: 56
      model_dt: 0.10 #0.05 # (1/20 = 0.05)
      batch_size: 2000
      ax_max: 4.0
      ax_min: -4.0
      ay_max: 0.0
      az_max: 3.5
      vx_std: 0.5 #0.2
      vy_std: 0.2
      wz_std: 0.8 #0.4
      vx_max: 1.0 
      vx_min: -1.0
      vy_max: 0.0
      wz_max: 2.0
      iteration_count: 1
      prune_distance: 20.0 #10.0 #5.0 # 1.7 was 1.7 limiting the speed 1m/s to 0.3m/s?
      transform_tolerance: 0.5  # 增加变换容错性
      temperature: 0.3
      gamma: 0.015
      visualize: true
      regenerate_noises: true
      
      motion_model: "Ackermann"
      AckermannConstraints:
        min_turning_r: 1.5
        
      TrajectoryVisualizer:
        trajectory_step: 5
        time_step: 3
        
      critics: [
        "ConstraintCritic", "CostCritic", "GoalCritic",
        "GoalAngleCritic", "PathAlignCritic", "PathFollowCritic",
        "PathAngleCritic", "PreferForwardCritic", "TwirlingCritic"
      ]
      
      ConstraintCritic:
        enabled: true
        cost_power: 1
        cost_weight: 4.0
        
      GoalCritic:
        enabled: true
        cost_power: 1
        cost_weight: 5.0
        threshold_to_consider: 1.4
        
      GoalAngleCritic:
        enabled: true
        cost_power: 1
        cost_weight: 3.0
        threshold_to_consider: 0.5
        
      PreferForwardCritic:
        enabled: true
        cost_power: 1
        cost_weight: 1.0
        threshold_to_consider: 0.8
        
      TwirlingCritic:
        enabled: true
        cost_power: 1
        cost_weight: 10.0
        
      CostCritic:
        enabled: true
        cost_power: 1
        cost_weight: 3.81
        near_collision_cost: 253
        critical_cost: 300.0
        consider_footprint: false #true
        collision_cost: 1000000.0
        near_goal_distance: 1.0
        trajectory_point_step: 2
        
      PathAlignCritic:
        enabled: true
        cost_power: 1
        cost_weight: 14.0
        max_path_occupancy_ratio: 0.05
        trajectory_point_step: 4
        threshold_to_consider: 0.5
        offset_from_furthest: 20
        use_path_orientations: false # true doesnt help true SMAC planner does not provide this
        
      PathFollowCritic:
        enabled: true
        cost_power: 1
        cost_weight: 5.0
        offset_from_furthest: 5 #10 #5
        threshold_to_consider: 1.4
        
      PathAngleCritic:
        enabled: true
        cost_power: 1
        cost_weight: 2.0
        offset_from_furthest: 4 #10 #4
        threshold_to_consider: 0.5
        max_angle_to_furthest: 1.0
        mode: 0

local_costmap:
  local_costmap:
    ros__parameters:
      update_frequency: 10.0
      publish_frequency: 5.0
      global_frame: odom
      robot_base_frame: mid_link
      rolling_window: true
      width: 10
      height: 10
      resolution: 0.05

      footprint_padding: 0.05
      footprint: "[[0.40, 0.20], [0.40, -0.20], [-0.40, -0.20], [-0.40, 0.20]]"
      # robot_radius: 0.500 #0.350

      # plugins: ["obstacle_layer", "inflation_layer", "voxel_layer"]
      plugins: ["obstacle_layer", "inflation_layer"]
      obstacle_layer:
        plugin: "nav2_costmap_2d::ObstacleLayer"
        enabled: True
        footprint_clearing_enabled: true
        max_obstacle_height: 2.0
        combination_method: 1
        observation_sources: scan tof_fc tof_fl tof_fr tof_rc tof_rl tof_rr
        # observation_sources: scan
        scan:
          topic: /scan
          obstacle_max_range: 4.0 #5.0
          obstacle_min_range: 0.0
          raytrace_max_range: 10.0
          raytrace_min_range: 0.0
          max_obstacle_height: 2.0
          min_obstacle_height: 0.0
          clearing: True
          marking: True
          data_type: "LaserScan"
          inf_is_valid: false
        tof_fc:
          topic: /tof_fc
          sensor_frame: tof_fc_link
          data_type: "PointCloud2"
          marking: True
          clearing: True
          min_obstacle_height: 0.15
          max_obstacle_height: 0.5
          obstacle_range: 2.0
          raytrace_range: 2.5
          inf_is_valid: false
        tof_fl:
          topic: /tof_fl
          sensor_frame: tof_fl_link
          data_type: "PointCloud2"
          marking: True
          clearing: True
          min_obstacle_height: 0.15
          max_obstacle_height: 0.5
          obstacle_range: 2.0
          raytrace_range: 2.5
          inf_is_valid: false
        tof_fr:
          topic: /tof_fr
          sensor_frame: tof_fr_link
          data_type: "PointCloud2"
          marking: True
          clearing: True
          min_obstacle_height: 0.15
          max_obstacle_height: 1.0
          obstacle_range: 2.0
          raytrace_range: 2.5
          inf_is_valid: false
        tof_rc:
          topic: /tof_rc
          sensor_frame: tof_rc_link
          data_type: "PointCloud2"
          marking: True
          clearing: True
          min_obstacle_height: 0.15
          max_obstacle_height: 1.0
          obstacle_range: 2.0
          raytrace_range: 2.5
          inf_is_valid: false
        tof_rl:
          topic: /tof_rl
          sensor_frame: tof_rl_link
          data_type: "PointCloud2"
          marking: True
          clearing: True
          min_obstacle_height: 0.15
          max_obstacle_height: 1.0
          obstacle_range: 2.0
          raytrace_range: 2.5
          inf_is_valid: false
        tof_rr:
          topic: /tof_rr
          sensor_frame: tof_fr_link
          data_type: "PointCloud2"
          marking: True
          clearing: True
          min_obstacle_height: 0.15
          max_obstacle_height: 1.0
          obstacle_range: 2.0
          raytrace_range: 2.5
          inf_is_valid: false
      inflation_layer:
        plugin: "nav2_costmap_2d::InflationLayer"
        enabled: true
        inflation_radius: 2.0 #0.4 #0.51 #0.400
        cost_scaling_factor: 10.0 #1.0
        inflate_unknown: false
        inflate_around_unknown: true
      always_send_full_costmap: True

global_costmap:
  global_costmap:
    ros__parameters:
      update_frequency: 1.0
      publish_frequency: 1.0
      global_frame: map
      robot_base_frame: mid_link
      rolling_window: true
      width: 100
      height: 100
      resolution: 0.1

      # footprint_padding: 0.05
      # footprint: "[[0.40, 0.18], [0.40, -0.18], [-0.40, -0.18], [-0.40, 0.18]]"
      robot_radius: 0.35 #0.25 #0.1

      track_unknown_space: False #true
      plugins: ["static_layer", "obstacle_layer", "inflation_layer"]
      # plugins: ["static_layer", "obstacle_layer"]
      obstacle_layer:
        plugin: "nav2_costmap_2d::ObstacleLayer"
        enabled: True
        footprint_clearing_enabled: False
        observation_sources: scan
        scan:
          topic: /scan
          max_obstacle_height: 2.0
          clearing: True
          marking: True
          data_type: "LaserScan"
          raytrace_max_range: 20.0
          raytrace_min_range: 0.0
          obstacle_max_range: 4.0 #19.5
          obstacle_min_range: 0.0
      static_layer:
        plugin: "nav2_costmap_2d::StaticLayer"
        enabled: True
        footprint_clearing_enabled: False
        map_subscribe_transient_local: True
      inflation_layer:
        plugin: "nav2_costmap_2d::InflationLayer"
        cost_scaling_factor: 10.0 #3.0
        inflation_radius: 2.0 #0.25
      always_send_full_costmap: True

map_server:
  ros__parameters:
    # yaml_filename: "/media/onion/data/sample/gazebo_car/src/gazebo_ackermann_steering_vehicle/map/slam_map.yaml"
    yaml_filename: ""

map_saver:
  ros__parameters:
    save_map_timeout: 5.0
    free_thresh_default: 0.25
    occupied_thresh_default: 0.65
    map_subscribe_transient_local: True

planner_server:
  ros__parameters:
    expected_planner_frequency: 10.0 #20.0 #10.0 #20.0
    # planner_plugins: ["GridBased", "SmacPlannerHybrid"]
    planner_plugins: ["GridBased"]
    costmap_update_timeout: 1.0
    
    GridBased:
    #   plugin: "nav2_navfn_planner::NavfnPlanner"
    #   tolerance: 0.5
    #   use_astar: false
    #   allow_unknown: False #true
    #   use_final_approach_orientation: false
      
    # SmacPlannerHybrid:

      # plugin: "nav2_smac_planner::SmacPlannerHybrid"
      # downsample_costmap: false
      # downsampling_factor: 1
      # tolerance: 0.25
      # allow_unknown: False #true
      # max_iterations: 1000000
      # max_on_approach_iterations: 1000
      # max_planning_time: 20.0 #10.0  # 增加规划时间以支持复杂机动
      # motion_model_for_search: "REEDS_SHEPP"  # 支持前进/后退的模型
      # angle_quantization_bins: 72
      # analytic_expansion_ratio: 3.5
      # analytic_expansion_max_length: 3.0
      # minimum_turning_radius: 1.5
      # reverse_penalty: 2.0 #0.3 #2.0  # 显著降低倒车惩罚，允许掉头时倒车
      # change_penalty: 0.1   # 降低方向改变惩罚
      # non_straight_penalty: 1.0  # 降低非直线惩罚
      # cost_penalty: 2.0
      # retrospective_penalty: 0.010  # 降低回溯惩罚
      # lookup_table_size: 20.0
      # cache_obstacle_heuristic: false
      # debug_visualizations: False #true  # 启用调试可视化
      # use_quadratic_cost_penalty: False
      # downsample_obstacle_heuristic: True
      # goal_heading_mode: "ALL_DIRECTION"        # DEFAULT, BIDIRECTIONAL, ALL_DIRECTION
      # smooth_path: True

      # https://docs.ros.org/en/humble/p/nav2_smac_planner/
      plugin: "nav2_smac_planner::SmacPlannerLattice"
      # plugin: "nav2_smac_planner::SmacPlannerHybrid"
      tolerance: 0.5                      # tolerance for planning if unable to reach exact pose, in meters
      downsample_costmap: false           # whether or not to downsample the map
      downsampling_factor: 1              # multiplier for the resolution of the costmap layer (e.g. 2 on a 5cm costmap would be 10cm)
      allow_unknown: false                # allow traveling in unknown space
      max_iterations: 1000000             # maximum total iterations to search for before failing (in case unreachable), set to -1 to disable
      max_on_approach_iterations: 1000    # maximum number of iterations to attempt to reach goal once in tolerance
      max_planning_time: 3.5              # max time in s for planner to plan, smooth, and upsample. Will scale maximum smoothing and upsampling times based on remaining time after planning.
      motion_model_for_search: "DUBIN"    # For Hybrid Dubin, Redds-Shepp
      cost_travel_multiplier: 2.0         # For 2D: Cost multiplier to apply to search to steer away from high cost areas. Larger values will place in the center of aisles more exactly (if non-`FREE` cost potential field exists) but take slightly longer to compute. To optimize for speed, a value of 1.0 is reasonable. A reasonable tradeoff value is 2.0. A value of 0.0 effective disables steering away from obstacles and acts like a naive binary search A*.
      angle_quantization_bins: 64         # For Hybrid nodes: Number of angle bins for search, must be 1 for 2D node (no angle search)
      analytic_expansion_ratio: 3.5       # For Hybrid/Lattice nodes: The ratio to attempt analytic expansions during search for final approach.
      analytic_expansion_max_length: 3.0  # For Hybrid/Lattice nodes: The maximum length of the analytic expansion to be considered valid to prevent unsafe shortcutting (in meters). This should be scaled with minimum turning radius and be no less than 4-5x the minimum radius
      minimum_turning_radius: 1.5 #0.40   # For Hybrid/Lattice nodes: minimum turning radius in m of path / vehicle
      reverse_penalty: 2.1                # For Reeds-Shepp model: penalty to apply if motion is reversing, must be => 1
      change_penalty: 0.0                 # For Hybrid nodes: penalty to apply if motion is changing directions, must be >= 0
      non_straight_penalty: 1.20          # For Hybrid nodes: penalty to apply if motion is non-straight, must be => 1
      cost_penalty: 2.0                   # For Hybrid nodes: penalty to apply to higher cost areas when adding into the obstacle map dynamic programming distance expansion heuristic. This drives the robot more towards the center of passages. A value between 1.3 - 3.5 is reasonable.
      retrospective_penalty: 0.025        # For Hybrid/Lattice nodes: penalty to prefer later maneuvers before earlier along the path. Saves search time since earlier nodes are not expanded until it is necessary. Must be >= 0.0 and <= 1.0
      rotation_penalty: 5.0               # For Lattice node: Penalty to apply only to pure rotate in place commands when using minimum control sets containing rotate in place primitives. This should always be set sufficiently high to weight against this action unless strictly necessary for obstacle avoidance or there may be frequent discontinuities in the plan where it requests the robot to rotate in place to short-cut an otherwise smooth path for marginal path distance savings.
      lookup_table_size: 20.0             # For Hybrid nodes: Size of the dubin/reeds-sheep distance window to cache, in meters.
      cache_obstacle_heuristic: True      # For Hybrid nodes: Cache the obstacle map dynamic programming distance expansion heuristic between subsiquent replannings of the same goal location. Dramatically speeds up replanning performance (40x) if costmap is largely static.
      allow_reverse_expansion: False      # For Lattice nodes: Whether to expand state lattice graph in forward primitives or reverse as well, will double the branching factor at each step.
  
      #Goal heading mode enum string to plan goal with multiple orientation. 
      #Options are “DEFAULT”, “BIDIRECTIONAL” and “ALL_DIRECTION”. 
      #With default mode, the planner will plan the goal with the orientation of the goal pose 
      #as was sent by the user. 
      #With the “BIDIRECTIONAL” mode, the planner will plan the goal with the orientation
      #of the goal pose and with orientation 180 degree offset from the goal pose orientation. 
      #For “ALL_DIRECTION” mode, the planner will plan the goal with the orientation
      #of the goal pose and all the possible orientation based on the angle quantization bins. 
      #For both the “BIDIRECTIONAL” and “ALL_DIRECTION” mode, the planner returns the path
      #with the minimum cost.
      goal_heading_mode: "ALL_DIRECTION"  # DEFAULT, BIDIRECTIONAL, ALL_DIRECTION      
      
      # Number of goal heading bins to skip during the coarse search phase of analytic expansion
      # goal-finding. When a goal is found, a fine search is performed to determine the exact
      # path during full-resolution. 
      # This parameter is only used when the goal heading mode is set to “ALL_DIRECTION” 
      # and It helps to reduce search time of analytic expansions. 
      # during the coarse search phase of analytic expansion goal-finding. 
      # When a goal is found, a fine search is performed to determine the exact path
      # during full-resolution. 
      # It is recommended to only do coarser search if the number of bins are > 24. 
      # Otherwise, leave as 1 (fine search).
      coarse_search_resolution: "1"

      smooth_path: True  # For Lattice/Hybrid nodes: Whether or not to smooth the path, always true for 2D nodes.
      smoother:
        max_iterations: 1000
        w_smooth: 0.3
        w_data: 0.2
        tolerance: 1.0e-10
        do_refinement: true               # Whether to recursively run the smoother 3 times on 

smoother_server:
  ros__parameters:
    smoother_plugins: ["simple_smoother"]
    simple_smoother:
      plugin: "nav2_smoother::SimpleSmoother"
      tolerance: 1.0e-10
      max_its: 1000
      do_refinement: True

behavior_server:
  ros__parameters:
    local_costmap_topic: local_costmap/costmap_raw
    global_costmap_topic: global_costmap/costmap_raw
    local_footprint_topic: local_costmap/published_footprint
    global_footprint_topic: global_costmap/published_footprint
    cycle_frequency: 10.0
    behavior_plugins: ["spin", "backup", "drive_on_heading", "assisted_teleop", "wait"]
    spin:
      plugin: "nav2_behaviors::Spin"
      is_recovery: False
    backup:
      plugin: "nav2_behaviors::BackUp"
    drive_on_heading:
      plugin: "nav2_behaviors::DriveOnHeading"
    wait:
      plugin: "nav2_behaviors::Wait"
    assisted_teleop:
      plugin: "nav2_behaviors::AssistedTeleop"
    local_frame: odom
    global_frame: map
    robot_base_frame: base_footprint
    transform_tolerance: 0.1
    simulate_ahead_time: 5.0 #2.0
    max_rotational_vel: 2.0
    min_rotational_vel: 0.1
    rotational_acc_lim: 3.0

waypoint_follower:
  ros__parameters:
    loop_rate: 10 #20 #10 #20
    stop_on_failure: false
    action_server_result_timeout: 900.0
    waypoint_task_executor_plugin: "wait_at_waypoint"
    wait_at_waypoint:
      plugin: "nav2_waypoint_follower::WaitAtWaypoint"
      enabled: False
      waypoint_pause_duration: 200

velocity_smoother:
  ros__parameters:
    smoothing_frequency: 20.0 #10.0 #20.0
    scale_velocities: False
    feedback: "OPEN_LOOP" #"CLOSED_LOOP" Closed loop caused 0.1m/s accel/decel
    max_velocity: [1.0, 0.0, 2.0] #[1.0, 0.0, 2.0]  # 与MPPI配置匹配 (wz_max: 1.9)
    min_velocity: [-1.0, 0.0, -2.0]  # 支持倒车
    max_accel: [1.0, 0.0, 2.0]
    max_decel: [-1.0, 0.0, -2.0]
    odom_topic: "wheel_odom"
    odom_duration: 0.1
    deadband_velocity: [0.02, 0.0, 0.0]
    velocity_timeout: 1.0

collision_monitor:
  ros__parameters:
    base_frame_id: "mid_link"
    odom_frame_id: "odom"
    cmd_vel_in_topic: "cmd_vel_smoothed"
    cmd_vel_out_topic: "cmd_vel"
    transform_tolerance: 0.5
    source_timeout: 5.0
    stop_pub_timeout: 2.0
    enable_stamped_cmd_vel: False # False for Jazzy or older by default
    polygons: ["PolygonStop", "PolygonSlow"]
    PolygonStop:
      type: "polygon"
      # points: "[[0.35, 0.2], [0.35, -0.2], [-0.45, -0.2], [-0.45, 0.2]]"
      points: "[[0.45, 0.2], [0.45, -0.2], [-0.45, -0.2], [-0.45, 0.2]]"
      action_type: "stop"
      min_points: 4  # max_points: 3 for Humble
      visualize: True
      polygon_pub_topic: "polygon_stop"
    PolygonSlow:
      type: "polygon"
      # points: "[[0.45, 0.3], [0.45, -0.3], [-0.55, -0.3], [-0.55, 0.3]]"
      points: "[[1.0, 0.3], [1.0, -0.3], [-1.0, -0.3], [-1.0, 0.3]]"
      action_type: "slowdown"
      min_points: 4  # max_points: 3 for Humble
      slowdown_ratio: 0.3
      visualize: True
      polygon_pub_topic: "polygon_slowdown"
    #observation_sources: ["scan"]
    observation_sources: ["scan", "tof_fc", "tof_fl", "tof_fr"]
    # observation_sources: ["scan", "tof_rc", "tof_rl", "tof_rr", "tof_fc", "tof_fl", "tof_fr"]
    scan:
      type: "scan"
      topic: "scan"
    # tof_rc:
    #   type: "pointcloud"
    #   topic: "/tof_rc"
    #   min_height: 0.15
    #   max_height: 0.5
    # tof_rl:
    #   type: "pointcloud"
    #   topic: "/tof_rl"
    #   min_height: 0.15
    #   max_height: 0.5
    # tof_rr:
    #   type: "pointcloud"
    #   topic: "/tof_rr"
    #   min_height: 0.15
    #   max_height: 0.5
    tof_fc:
      type: "pointcloud"
      topic: "/tof_fc"
      min_height: 0.15
      max_height: 0.5
    tof_fl:
      type: "pointcloud"
      topic: "/tof_fl"
      min_height: 0.15
      max_height: 0.5
    tof_fr:
      type: "pointcloud"
      topic: "/tof_fr"
      min_height: 0.15
      max_height: 0.5

docking_server:
  ros__parameters:
    controller_frequency: 50.0
    initial_perception_timeout: 5.0
    wait_charge_timeout: 5.0
    dock_approach_timeout: 30.0
    undock_linear_tolerance: 0.05
    undock_angular_tolerance: 0.1
    max_retries: 3
    base_frame: "base_footprint"
    fixed_frame: "odom"
    dock_backwards: false
    dock_prestaging_tolerance: 0.5

    dock_plugins: ['simple_charging_dock']
    simple_charging_dock:
      plugin: 'opennav_docking::SimpleChargingDock'
      docking_threshold: 0.05
      staging_x_offset: -0.7
      use_external_detection_pose: true
      use_battery_status: false
      use_stall_detection: false

      external_detection_timeout: 1.0
      external_detection_translation_x: -0.18
      external_detection_translation_y: 0.0
      external_detection_rotation_roll: -1.57
      external_detection_rotation_pitch: -1.57
      external_detection_rotation_yaw: 0.0
      filter_coef: 0.1

    controller:
      k_phi: 3.0
      k_delta: 2.0
      v_linear_min: 0.15
      v_linear_max: 0.15
      use_collision_detection: true
      costmap_topic: "local_costmap/costmap_raw"
      footprint_topic: "local_costmap/published_footprint"
      transform_tolerance: 0.1
      projection_time: 5.0
      simulation_step: 0.1
      dock_collision_threshold: 0.3

# loopback_simulator:
#   ros__parameters:
#     base_frame_id: "base_footprint"
#     odom_frame_id: "odom"
#     map_frame_id: "map"
#     scan_frame_id: "lidar_link"
#     update_duration: 0.02